<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Chat</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase CDN Scripts -->
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <h1>Chat us!</h1>
            <div class="auth-buttons">
                <a class="btn12" href="signup.html">SIGN UP</a>
                <a class="btn12" href="login.html">SIGN IN</a>
            </div>
        </div>
        
        <!-- Display username here -->
        <div id="username-container">
            <p>Welcome, <span id="username-display">User</span></p>
        </div>
        
        <div id="chat-box" class="chat-box">
            <!-- Messages will be displayed here -->
        </div>          

        <div class="input-container">
            <input type="text" id="message-input" placeholder="Type your message...">
            <input type="file" id="file-input" accept="image/*,video/*,application/*"> <!-- File input for media -->
            <button id="send-button">Send</button>
        </div>
    </div>
    
    <!-- Progress Bar Popup -->
    <div id="progress-popup" style="display:none;">
        <div id="progress-container">
            <progress id="upload-progress" value="0" max="100"></progress>
            <span id="upload-progress-text">0%</span>
        </div>
    </div>

    <!-- Firebase Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, orderBy, query } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCYY2GQqS0tCXb7Oxw8AWXhpexq9e8VRUs",
            authDomain: "aspirehub-32863.firebaseapp.com",
            projectId: "aspirehub-32863",
            storageBucket: "aspirehub-32863.appspot.com",
            messagingSenderId: "686810111182",
            appId: "1:686810111182:web:4290b4b1b6e64934ec449f",
            measurementId: "G-KX41R0SSMY"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Set username in the display
                const usernameDisplay = document.getElementById('username-display');
                if (user.displayName) {
                    usernameDisplay.innerText = user.displayName; // Display user's set display name
                } else {
                    usernameDisplay.innerText = user.email.split('@')[0]; // Use email prefix if no username
                }
                console.log("User logged in:", user.email);
            } else {
                console.log("No user logged in");
                window.location.href = "login.html"; // Redirect to login page if not logged in
            }
        });

        // Send message function
        function sendMessage() {
            const message = document.getElementById("message-input").value;
            const fileInput = document.getElementById("file-input");
            const progressPopup = document.getElementById("progress-popup");
            const progressBar = document.getElementById("upload-progress");
            const progressText = document.getElementById("upload-progress-text");

            // If there is a file selected, upload it to Firebase Storage
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const fileSize = file.size / (1024 * 1024); // File size in MB
                const storageRef = ref(storage, 'chat-files/' + file.name);

                // Show progress popup
                progressPopup.style.display = 'block';
                
                // Start the file upload
                const uploadTask = uploadBytesResumable(storageRef, file);

                // Track the upload progress
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressBar.value = progress;
                        progressText.textContent = `${Math.round(progress)}%`;
                    }, 
                    (error) => {
                        console.error("Error uploading file: ", error);
                        // Hide progress if error occurs
                        progressPopup.style.display = 'none';
                    }, 
                    () => {
                        // Get the download URL after upload completes
                        getDownloadURL(uploadTask.snapshot.ref).then((url) => {
                            // Save the message with the file URL
                            addDoc(collection(db, "messages"), {
                                text: message.trim() || "Sent a media file",
                                timestamp: new Date(),
                                mediaUrl: url,
                                mediaType: file.type,
                                fileSize: file.size,  // Storing the file size for comparison
                                user: auth.currentUser.displayName || auth.currentUser.email
                            }).then(() => {
                                // Clear inputs
                                document.getElementById("message-input").value = "";
                                fileInput.value = ""; // Reset file input

                                // Hide progress popup after upload is done
                                progressPopup.style.display = 'none';
                            }).catch((error) => {
                                console.error("Error adding document: ", error);
                            });
                        });
                    }
                );
            } else if (message.trim() !== "") {
                // If there's no file, just send the text message
                addDoc(collection(db, "messages"), {
                    text: message,
                    timestamp: new Date(),
                    user: auth.currentUser.displayName || auth.currentUser.email
                }).then(() => {
                    document.getElementById("message-input").value = ""; // clear input
                }).catch((error) => {
                    console.error("Error adding document: ", error);
                });
            }
        }

        // Format timestamp into a readable date-time format
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp.seconds * 1000); // Convert to milliseconds
            return date.toLocaleString(); // Localized date-time format
        }

        // Real-time listener for messages, ordered by timestamp (oldest first)
        const q = query(collection(db, "messages"), orderBy("timestamp"));

        onSnapshot(q, (snapshot) => {
            const chatBox = document.getElementById("chat-box");
            chatBox.innerHTML = ""; // clear chat box

            snapshot.forEach((doc) => {
                const messageDiv = document.createElement("div");
                messageDiv.classList.add("message");

                const messageData = doc.data();

                if (messageData.mediaUrl) {
                    // Display media (image or video)
                    const mediaElement = document.createElement(messageData.mediaType.includes("image") ? "img" : "video");
                    mediaElement.src = messageData.mediaUrl;
                    mediaElement.controls = true;
                    mediaElement.style.maxWidth = "100%";
                    messageDiv.appendChild(mediaElement);

                    // For larger files, show download link instead of auto-download
                    if (messageData.fileSize > (3.5 * 1024 * 1024)) { // 3.5 MB in bytes
                        const downloadLink = document.createElement("a");
                        downloadLink.href = messageData.mediaUrl;
                        downloadLink.download = messageData.mediaUrl.split('/').pop();
                        downloadLink.innerText = "Download File";
                        downloadLink.style.color = "blue";
                        messageDiv.appendChild(downloadLink);
                    }
                } else {
                    // Display text message
                    messageDiv.innerText = `${messageData.user}: ${messageData.text}`;
                }

                // Add timestamp to the message in the bottom right corner
                const timestampDiv = document.createElement("div");
                timestampDiv.classList.add("timestamp");
                timestampDiv.innerText = formatTimestamp(messageData.timestamp);
                timestampDiv.style.textAlign = "right"; // Align to the right
                messageDiv.appendChild(timestampDiv);

                chatBox.appendChild(messageDiv);
            });

            // Scroll to bottom
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        // Add event listener to send button
        document.getElementById("send-button").addEventListener("click", sendMessage);
    </script>
</body>
</html>
